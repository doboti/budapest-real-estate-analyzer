{% extends "base.html" %}
{% block title %}T√©rk√©p - Hirdet√©sek{% endblock %}
{% block content %}
<div class="mt-3">
    <h1>üó∫Ô∏è T√©rk√©p</h1>
    <div class="alert alert-info">
        <strong>Haszn√°lat:</strong> Kattints egy ker√ºletre a t√©rk√©pen, hogy megjelenjenek az ott tal√°lhat√≥ hirdet√©sek!
    </div>
    
    <!-- T√©rk√©p kont√©ner -->
    <div class="card mb-4">
        <div class="card-body">
            <div id="map" style="width: 100%; height: 600px;"></div>
        </div>
    </div>

    <!-- Hirdet√©sek lista szekci√≥ -->
    <div id="listings-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">üìã <span id="district-name"></span> - Hirdet√©sek (<span id="listings-count">0</span> db)</h3>
            </div>
            <div class="card-body">
                <!-- Keres≈ëmez≈ë -->
                <div class="mb-3">
                    <input type="text" id="search-input" class="form-control" placeholder="üîç Keres√©s c√≠m, le√≠r√°s vagy √°r alapj√°n...">
                </div>

                <!-- Sz≈±r≈ëk -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label>Min. √År (M Ft):</label>
                        <input type="number" id="min-price" class="form-control" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <label>Max. √År (M Ft):</label>
                        <input type="number" id="max-price" class="form-control" placeholder="200">
                    </div>
                    <div class="col-md-3">
                        <label>Szob√°k:</label>
                        <select id="rooms-filter" class="form-control">
                            <option value="">√ñsszes</option>
                            <option value="1">1 szoba</option>
                            <option value="2">2 szoba</option>
                            <option value="3">3 szoba</option>
                            <option value="4">4+ szoba</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>&nbsp;</label>
                        <button id="clear-filters" class="btn btn-secondary btn-block w-100">üîÑ Sz≈±r≈ëk t√∂rl√©se</button>
                    </div>
                </div>

                <!-- Hirdet√©sek t√°bl√°zat -->
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="listings-table">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 30%">C√≠m</th>
                                <th style="width: 10%">√År</th>
                                <th style="width: 8%">Ter√ºlet</th>
                                <th style="width: 8%">Szob√°k</th>
                                <th style="width: 10%">√År/m¬≤</th>
                                <th style="width: 24%">Le√≠r√°s (r√©szlet)</th>
                                <th style="width: 10%">M≈±velet</th>
                            </tr>
                        </thead>
                        <tbody id="listings-tbody">
                            <!-- JavaScript t√∂lti fel -->
                        </tbody>
                    </table>
                </div>

                <!-- Tal√°latok sz√°ma -->
                <div class="alert alert-secondary mt-3">
                    <strong>Tal√°latok:</strong> <span id="filtered-count">0</span> hirdet√©s
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Folium t√©rk√©p JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
// Glob√°lis v√°ltoz√≥k
let allListings = [];
let currentDistrict = null;
let map = null;

// T√©rk√©p inicializ√°l√°sa
function initMap() {
    map = L.map('map', {
        attributionControl: false,  // Attribution jel√∂l≈ë elt√°vol√≠t√°sa
        zoomControl: false  // Zoom gombok elt√°vol√≠t√°sa
    }).setView([47.4979, 19.0402], 11);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    // GeoJSON bet√∂lt√©se
    fetch("{{ url_for('static', filename='budapest_districts.geojson') }}")
        .then(response => response.json())
        .then(data => {
            // Hirdet√©sek sz√°ma ker√ºletenk√©nt
            fetch('/api/districts-summary')
                .then(res => res.json())
                .then(summary => {
                    L.geoJSON(data, {
                        pointToLayer: function(feature, latlng) {
                            return null; // Tiltsa le a marker-eket
                        },
                        filter: function(feature) {
                            // Csak polygon-okat enged√©lyezz√ºnk
                            return feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon';
                        },
                        style: {
                            fillColor: 'yellow',
                            color: 'black',
                            weight: 1,
                            fillOpacity: 0.3
                        },
                        onEachFeature: function(feature, layer) {
                            const districtName = feature.properties.name || feature.properties.admin_leve;
                            const count = summary[districtName] || 0;
                            
                            // Tooltip a hirdet√©ssz√°mmal
                            layer.bindTooltip(`<b>${districtName}</b><br>Akt√≠v hirdet√©sek: ${count} db`, {
                                permanent: false,
                                sticky: true,
                                direction: 'auto'
                            });
                            
                            // Hover highlight
                            layer.on('mouseover', function() {
                                layer.setStyle({
                                    fillColor: 'orange',
                                    fillOpacity: 0.7,
                                    weight: 3,
                                    color: 'red'
                                });
                            });
                            
                            layer.on('mouseout', function() {
                                layer.setStyle({
                                    fillColor: 'yellow',
                                    fillOpacity: 0.3,
                                    weight: 1,
                                    color: 'black'
                                });
                            });
                            
                            // Kattint√°s event
                            layer.on('click', function() {
                                loadDistrictListings(districtName);
                            });
                        }
                    }).addTo(map);
                });
        })
        .catch(err => console.error('GeoJSON hiba:', err));
}

// Ker√ºlet hirdet√©seinek bet√∂lt√©se
function loadDistrictListings(district) {
    currentDistrict = district;
    document.getElementById('district-name').textContent = district;
    document.getElementById('listings-section').style.display = 'block';
    
    // Scroll a list√°hoz
    document.getElementById('listings-section').scrollIntoView({ behavior: 'smooth' });
    
    // API h√≠v√°s
    fetch(`/api/listings-by-district?district=${encodeURIComponent(district)}`)
        .then(response => response.json())
        .then(data => {
            allListings = data.listings;
            document.getElementById('listings-count').textContent = allListings.length;
            renderListings(allListings);
        })
        .catch(err => {
            console.error('API hiba:', err);
            alert('Hiba t√∂rt√©nt a hirdet√©sek bet√∂lt√©sekor!');
        });
}

// Hirdet√©sek megjelen√≠t√©se
function renderListings(listings) {
    const tbody = document.getElementById('listings-tbody');
    tbody.innerHTML = '';
    
    if (listings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nincs tal√°lat a megadott sz≈±r≈ëk alapj√°n.</td></tr>';
        document.getElementById('filtered-count').textContent = '0';
        return;
    }
    
    listings.forEach(listing => {
        const row = document.createElement('tr');
        
        // √År form√°z√°s
        const priceM = (listing.price_huf / 1000000).toFixed(1);
        const pricePerSqm = listing.price_per_sqm ? Math.round(listing.price_per_sqm) : 'N/A';
        
        // Le√≠r√°s r√∂vid√≠t√©s
        const descShort = listing.description ? 
            (listing.description.length > 100 ? listing.description.substring(0, 100) + '...' : listing.description) : 
            'Nincs le√≠r√°s';
        
        row.innerHTML = `
            <td><strong>${listing.title || 'Nincs c√≠m'}</strong></td>
            <td class="text-end"><strong>${priceM} M Ft</strong></td>
            <td class="text-center">${listing.area_sqm || 'N/A'} m¬≤</td>
            <td class="text-center">${listing.rooms || 'N/A'}</td>
            <td class="text-end">${pricePerSqm.toLocaleString()} Ft/m¬≤</td>
            <td><small class="text-muted">${descShort}</small></td>
            <td>
                <a href="${listing.link}" target="_blank" class="btn btn-primary btn-sm">
                    üîó Megtekint√©s
                </a>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    document.getElementById('filtered-count').textContent = listings.length;
}

// Keres√©s √©s sz≈±r√©s
function filterListings() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const minPrice = parseFloat(document.getElementById('min-price').value) * 1000000 || 0;
    const maxPrice = parseFloat(document.getElementById('max-price').value) * 1000000 || Infinity;
    const roomsFilter = document.getElementById('rooms-filter').value;
    
    const filtered = allListings.filter(listing => {
        // Sz√∂veges keres√©s
        const matchesSearch = !searchTerm || 
            (listing.title && listing.title.toLowerCase().includes(searchTerm)) ||
            (listing.description && listing.description.toLowerCase().includes(searchTerm)) ||
            (listing.price_huf && listing.price_huf.toString().includes(searchTerm));
        
        // √År sz≈±r√©s
        const matchesPrice = listing.price_huf >= minPrice && listing.price_huf <= maxPrice;
        
        // Szob√°k sz≈±r√©s
        const matchesRooms = !roomsFilter || 
            (roomsFilter === '4' ? listing.rooms >= 4 : listing.rooms == roomsFilter);
        
        return matchesSearch && matchesPrice && matchesRooms;
    });
    
    renderListings(filtered);
}

// Event listenerek
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    // Keres√©s input
    document.getElementById('search-input').addEventListener('input', filterListings);
    
    // Sz≈±r≈ëk
    document.getElementById('min-price').addEventListener('input', filterListings);
    document.getElementById('max-price').addEventListener('input', filterListings);
    document.getElementById('rooms-filter').addEventListener('change', filterListings);
    
    // Sz≈±r≈ëk t√∂rl√©se
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('search-input').value = '';
        document.getElementById('min-price').value = '';
        document.getElementById('max-price').value = '';
        document.getElementById('rooms-filter').value = '';
        if (allListings.length > 0) {
            renderListings(allListings);
        }
    });
});
</script>

<style>
#listings-section {
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

#listings-table tbody tr {
    cursor: pointer;
    transition: background-color 0.2s;
}

#listings-table tbody tr:hover {
    background-color: #f8f9fa !important;
}

.leaflet-popup-content-wrapper {
    border-radius: 8px;
}

/* Kattint√°skor megjelen≈ë n√©gyzet elt√°vol√≠t√°sa */
.leaflet-interactive {
    outline: none !important;
}

path.leaflet-interactive:focus {
    outline: none !important;
}

svg.leaflet-zoom-animated {
    outline: none !important;
}
</style>
{% endblock %}
