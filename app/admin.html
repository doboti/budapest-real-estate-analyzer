{% extends "base.html" %}
{% block title %}Admin Vez√©rl≈ëpult{% endblock %}
{% block content %}
<h1>üõ†Ô∏è Adminisztr√°ci√≥s Vez√©rl≈ëpult</h1>
<p class="text-muted">Er≈ëforr√°s-ig√©nyes m≈±veletek kezel√©se</p>

<!-- Adatfeldolgoz√°s szekci√≥ -->
<div class="card mt-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">üìä Adatfeldolgoz√°s (LLM Elemz√©s)</h5>
    </div>
    <div class="card-body">
        <p>Elind√≠tja a teljes ingatlanhirdet√©s-feldolgoz√°si pipeline-t az LLM modell seg√≠ts√©g√©vel.</p>
        <p><strong>Becs√ºlt id≈ë:</strong> 6-8 √≥ra (~12000 hirdet√©s)</p>
        <p><strong>Er≈ëforr√°s:</strong> GPU aj√°nlott (Ollama + llama3.2:3b)</p>
        
        <button onclick="startPipeline()" class="btn btn-warning btn-lg">
            üöÄ Adatfeldolgoz√°s Ind√≠t√°sa
        </button>
        
        <div id="pipelineStatus" class="mt-3 d-none">
            <div class="progress">
                <div id="pipelineProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%">0%</div>
            </div>
            <p id="pipelineMessage" class="mt-2 text-muted"></p>
        </div>
    </div>
</div>

<!-- ML Modell Tan√≠t√°s -->
<div class="card mt-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">ü§ñ Machine Learning Modell Tan√≠t√°sa</h5>
    </div>
    <div class="card-body">
        <p>√Årl√©tsz√°l√≥ ML modell betan√≠t√°sa a feldolgozott adatokb√≥l.</p>
        <p><strong>Becs√ºlt id≈ë:</strong> 5-10 perc</p>
        <p><strong>El≈ëfelt√©tel:</strong> Feldolgozott core_layer_filtered.parquet</p>
        
        <button onclick="trainModel()" class="btn btn-danger">
            üéì Modell Tan√≠t√°sa
        </button>
    </div>
</div>

<!-- Cache √©s Metadata Kezel√©s -->
<div class="card mt-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">üóÑÔ∏è Cache & Metadata Kezel√©s</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Redis Cache T√∂rl√©se</h6>
                <p class="small">LLM v√°laszok √∫jragener√°l√°s√°hoz</p>
                <button onclick="clearCache()" class="btn btn-info">
                    üóëÔ∏è Cache T√∂rl√©se
                </button>
            </div>
            <div class="col-md-6">
                <h6>Inkrement√°lis Metadata Reset</h6>
                <p class="small">Teljes √∫jrafeldolgoz√°shoz</p>
                <button onclick="resetIncremental()" class="btn btn-warning">
                    üîÑ Metadata T√∂rl√©se
                </button>
            </div>
        </div>
        <div class="mt-3">
            <a href="{{ url_for('cache_admin') }}" class="btn btn-outline-secondary">
                üìà Cache Statisztik√°k Megtekint√©se
            </a>
        </div>
    </div>
</div>

<!-- Rendszer Info -->
<div class="card mt-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">‚ÑπÔ∏è Fontos Inform√°ci√≥k</h5>
    </div>
    <div class="card-body">
        <ul>
            <li><strong>Lok√°lis futtat√°s:</strong> Ezek a m≈±veletek GPU/CPU intenz√≠vek, csak helyi k√∂rnyezetben haszn√°ld!</li>
            <li><strong>GCP Cloud Run:</strong> Ha felh≈ëben futtatod az appot, ezek a funkci√≥k NEM √©rhet≈ëk el.</li>
            <li><strong>Adat szinkroniz√°ci√≥:</strong> Feldolgoz√°s ut√°n a .parquet √©s .pkl f√°jlokat t√∂ltsd fel a repo-ba.</li>
            <li><strong>Docker:</strong> Ellen≈ërizd, hogy az Ollama kont√©ner fut-e (<code>docker ps</code>)</li>
        </ul>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();

    function startPipeline() {
        if (!confirm('Biztosan elind√≠tod a teljes adatfeldolgoz√°st? Ez 6-8 √≥r√°t vehet ig√©nybe!')) {
            return;
        }
        
        fetch('/run-pipeline', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('pipelineStatus').classList.remove('d-none');
                    document.getElementById('pipelineMessage').textContent = 'Feldolgoz√°s folyamatban...';
                    
                    // WebSocket csatlakoz√°s a progress tracking-hez
                    socket.emit('join', { room: data.task_id });
                    
                    alert('‚úÖ Adatfeldolgoz√°s elindult! Task ID: ' + data.task_id);
                } else {
                    alert('‚ùå Hiba: ' + data.error);
                }
            })
            .catch(err => alert('‚ùå H√°l√≥zati hiba: ' + err));
    }

    function trainModel() {
        if (!confirm('Elind√≠tod a modell tan√≠t√°s√°t?')) return;
        
        fetch('/train-model', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Modell tan√≠t√°s elindult a h√°tt√©rben!');
                } else {
                    alert('‚ùå Hiba: ' + data.message);
                }
            })
            .catch(err => alert('‚ùå H√°l√≥zati hiba: ' + err));
    }

    function clearCache() {
        if (!confirm('T√∂r√∂lni szeretn√©d a Redis cache-t? Az LLM v√°laszokat √∫jra kell majd gener√°lni.')) return;
        
        fetch('/admin/cache/clear', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Cache t√∂r√∂lve: ' + data.count + ' elem');
                } else {
                    alert('‚ùå Hiba: ' + data.error);
                }
            })
            .catch(err => alert('‚ùå H√°l√≥zati hiba: ' + err));
    }

    function resetIncremental() {
        if (!confirm('T√∂r√∂lni szeretn√©d az inkrement√°lis metadata-t? A k√∂vetkez≈ë futtat√°s MINDEN hirdet√©st feldolgoz.')) return;
        
        fetch('/admin/incremental/reset', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Metadata t√∂r√∂lve!');
                } else {
                    alert('‚ùå Hiba: ' + data.error);
                }
            })
            .catch(err => alert('‚ùå H√°l√≥zati hiba: ' + err));
    }

    // WebSocket progress tracking
    socket.on('progress', function(data) {
        const percent = data.percent || 0;
        document.getElementById('pipelineProgress').style.width = percent + '%';
        document.getElementById('pipelineProgress').textContent = percent.toFixed(1) + '%';
        document.getElementById('pipelineMessage').textContent = data.message || '';
    });

    socket.on('completed', function(data) {
        document.getElementById('pipelineMessage').textContent = '‚úÖ Feldolgoz√°s befejezve!';
        document.getElementById('pipelineProgress').classList.remove('progress-bar-animated');
        alert('‚úÖ Adatfeldolgoz√°s k√©sz!\nRelevans: ' + data.relevant + ', Irrelevans: ' + data.irrelevant);
    });
</script>
{% endblock %}
