{% extends "base.html" %}
{% block title %}Admin Vez√©rl≈ëpult{% endblock %}
{% block content %}
<h1>üõ†Ô∏è Adminisztr√°ci√≥s Vez√©rl≈ëpult</h1>
<p class="text-muted">Er≈ëforr√°s-ig√©nyes m≈±veletek kezel√©se</p>

<!-- GCP Adatfriss√≠t√©s szekci√≥ (√öJ) -->
<div class="card mt-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">‚òÅÔ∏è GCP Adatfriss√≠t√©s</h5>
    </div>
    <div class="card-body">
        <p>Ellen≈ërizd √©s t√∂ltsd le a legfrissebb core_data.parquet f√°jlt a Google Cloud Storage-b√≥l.</p>
        <p><strong>Bucket:</strong> ingatlan-core-eu/core_data.parquet</p>
        
        <div class="btn-group" role="group">
            <button onclick="checkGCPUpdate()" class="btn btn-outline-success">
                üîç Friss√≠t√©s Ellen≈ërz√©se
            </button>
            <button onclick="downloadFromGCP()" class="btn btn-success" id="downloadBtn" disabled>
                ‚¨áÔ∏è Let√∂lt√©s GCP-b≈ël
            </button>
        </div>
        
        <div id="gcpStatus" class="mt-3 d-none">
            <div class="alert" id="gcpAlert"></div>
            <table class="table table-sm" id="gcpTable">
                <thead>
                    <tr>
                        <th>Verzi√≥</th>
                        <th>Friss√≠tve</th>
                        <th>M√©ret</th>
                        <th>√Ållapot</th>
                    </tr>
                </thead>
                <tbody id="gcpTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Adatfeldolgoz√°s szekci√≥ -->
<div class="card mt-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">üìä Adatfeldolgoz√°s (LLM Elemz√©s)</h5>
    </div>
    <div class="card-body">
        <p>Elind√≠tja a teljes ingatlanhirdet√©s-feldolgoz√°si pipeline-t az LLM modell seg√≠ts√©g√©vel.</p>
        <p><strong>Becs√ºlt id≈ë:</strong> 6-8 √≥ra (~12000 hirdet√©s)</p>
        <p><strong>Er≈ëforr√°s:</strong> GPU aj√°nlott (Ollama + llama3.2:3b)</p>
        
        <button onclick="startPipeline()" class="btn btn-warning btn-lg">
            üöÄ Adatfeldolgoz√°s Ind√≠t√°sa
        </button>
        
        <div id="pipelineStatus" class="mt-3 d-none">
            <div class="progress">
                <div id="pipelineProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%">0%</div>
            </div>
            <p id="pipelineMessage" class="mt-2 text-muted"></p>
        </div>
    </div>
</div>

<!-- ML Modell Tan√≠t√°s -->
<div class="card mt-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">ü§ñ Machine Learning Modell Tan√≠t√°sa</h5>
    </div>
    <div class="card-body">
        <p>√Årl√©tsz√°l√≥ ML modell betan√≠t√°sa a feldolgozott adatokb√≥l.</p>
        <p><strong>Becs√ºlt id≈ë:</strong> 5-10 perc</p>
        <p><strong>El≈ëfelt√©tel:</strong> Feldolgozott core_layer_filtered.parquet</p>
        
        <button onclick="trainModel()" class="btn btn-danger">
            üéì Modell Tan√≠t√°sa
        </button>
    </div>
</div>

<!-- Modulok Tesztel√©se (√öJ) -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üîß Modulok Tesztel√©se</h5>
    </div>
    <div class="card-body">
        <p>Rendszerkomponensek el√©rhet≈ës√©g√©nek √©s m≈±k√∂d√©s√©nek ellen≈ërz√©se.</p>
        
        <button onclick="testAllModules()" class="btn btn-primary btn-lg mb-3">
            üöÄ √ñsszes Modul Tesztel√©se
        </button>
        
        <div class="row mt-3">
            <div class="col-md-4 mb-2">
                <button onclick="testModule('redis')" class="btn btn-outline-primary w-100">
                    üóÑÔ∏è Redis
                </button>
            </div>
            <div class="col-md-4 mb-2">
                <button onclick="testModule('ollama')" class="btn btn-outline-primary w-100">
                    ü§ñ Ollama (LLM)
                </button>
            </div>
            <div class="col-md-4 mb-2">
                <button onclick="testModule('parquet')" class="btn btn-outline-primary w-100">
                    üìä Parquet F√°jl
                </button>
            </div>
            <div class="col-md-4 mb-2">
                <button onclick="testModule('gcp')" class="btn btn-outline-primary w-100">
                    ‚òÅÔ∏è GCP Storage
                </button>
            </div>
            <div class="col-md-4 mb-2">
                <button onclick="testModule('airflow')" class="btn btn-outline-primary w-100">
                    üå™Ô∏è Airflow API
                </button>
            </div>
            <div class="col-md-4 mb-2">
                <button onclick="testModule('model')" class="btn btn-outline-primary w-100">
                    üéØ ML Modell
                </button>
            </div>
        </div>
        
        <div id="moduleTestResults" class="mt-4 d-none">
            <h6>Teszt Eredm√©nyek:</h6>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Modul</th>
                            <th>√Ållapot</th>
                            <th>V√°laszid≈ë</th>
                            <th>R√©szletek</th>
                        </tr>
                    </thead>
                    <tbody id="moduleTestTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Cache √©s Metadata Kezel√©s -->
<div class="card mt-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">üóÑÔ∏è Cache & Metadata Kezel√©s</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Redis Cache T√∂rl√©se</h6>
                <p class="small">LLM v√°laszok √∫jragener√°l√°s√°hoz</p>
                <button onclick="clearCache()" class="btn btn-info">
                    üóëÔ∏è Cache T√∂rl√©se
                </button>
            </div>
            <div class="col-md-6">
                <h6>Inkrement√°lis Metadata Reset</h6>
                <p class="small">Teljes √∫jrafeldolgoz√°shoz</p>
                <button onclick="resetIncremental()" class="btn btn-warning">
                    üîÑ Metadata T√∂rl√©se
                </button>
            </div>
        </div>
        <div class="mt-3">
            <a href="{{ url_for('cache_admin') }}" class="btn btn-outline-secondary">
                üìà Cache Statisztik√°k Megtekint√©se
            </a>
        </div>
    </div>
</div>

<!-- Rendszer Info -->
<div class="card mt-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">‚ÑπÔ∏è Fontos Inform√°ci√≥k</h5>
    </div>
    <div class="card-body">
        <ul>
            <li><strong>Lok√°lis futtat√°s:</strong> Ezek a m≈±veletek GPU/CPU intenz√≠vek, csak helyi k√∂rnyezetben haszn√°ld!</li>
            <li><strong>GCP Cloud Run:</strong> Ha felh≈ëben futtatod az appot, ezek a funkci√≥k NEM √©rhet≈ëk el.</li>
            <li><strong>Adat szinkroniz√°ci√≥:</strong> Feldolgoz√°s ut√°n a .parquet √©s .pkl f√°jlokat t√∂ltsd fel a repo-ba.</li>
            <li><strong>Docker:</strong> Ellen≈ërizd, hogy az Ollama kont√©ner fut-e (<code>docker ps</code>)</li>
        </ul>
    </div>
</div>

<script>
    function startPipeline() {
        if (!confirm('Biztosan elind√≠tod a teljes adatfeldolgoz√°st? Ez 6-8 √≥r√°t vehet ig√©nybe!')) {
            return;
        }
        
        fetch('/run-pipeline', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('pipelineStatus').classList.remove('d-none');
                    document.getElementById('pipelineMessage').textContent = 'Feldolgoz√°s folyamatban...';
                    
                    alert('‚úÖ Adatfeldolgoz√°s elindult! Task ID: ' + data.task_id + '\n\nA folyamat a h√°tt√©rben fut. Az eredm√©nyeket k√©s≈ëbb ellen≈ërizheted.');
                } else {
                    alert('‚ùå Hiba: ' + data.error);
                }
            })
            .catch(err => alert('‚ùå H√°l√≥zati hiba: ' + err));
    }

    function trainModel() {
        if (!confirm('Elind√≠tod a modell tan√≠t√°s√°t?')) return;
        
        fetch('/train-model', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Modell tan√≠t√°s elindult a h√°tt√©rben!');
                } else {
                    alert('‚ùå Hiba: ' + data.message);
                }
            })
            .catch(err => alert('‚ùå H√°l√≥zati hiba: ' + err));
    }

    function clearCache() {
        if (!confirm('T√∂r√∂lni szeretn√©d a Redis cache-t? Az LLM v√°laszokat √∫jra kell majd gener√°lni.')) return;
        
        fetch('/admin/cache/clear', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Cache t√∂r√∂lve: ' + data.count + ' elem');
                } else {
                    alert('‚ùå Hiba: ' + data.error);
                }
            })
            .catch(err => alert('‚ùå H√°l√≥zati hiba: ' + err));
    }

    function resetIncremental() {
        if (!confirm('T√∂r√∂lni szeretn√©d az inkrement√°lis metadata-t? A k√∂vetkez≈ë futtat√°s MINDEN hirdet√©st feldolgoz.')) return;
        
        fetch('/admin/incremental/reset', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Metadata t√∂r√∂lve!');
                } else {
                    alert('‚ùå Hiba: ' + data.error);
                }
            })
            .catch(err => alert('‚ùå H√°l√≥zati hiba: ' + err));
    }

    // ========== GCP Funkci√≥k ==========
    function checkGCPUpdate() {
        const statusDiv = document.getElementById('gcpStatus');
        const alertDiv = document.getElementById('gcpAlert');
        const tableBody = document.getElementById('gcpTableBody');
        const downloadBtn = document.getElementById('downloadBtn');
        
        statusDiv.classList.remove('d-none');
        alertDiv.className = 'alert alert-info';
        alertDiv.textContent = 'üîç Ellen≈ërz√©s folyamatban...';
        
        fetch('/admin/gcp/check-update')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const isNewer = data.is_newer;
                    alertDiv.className = isNewer ? 'alert alert-warning' : 'alert alert-success';
                    alertDiv.innerHTML = `<strong>${data.recommendation}</strong>`;
                    
                    // T√°bl√°zat felt√∂lt√©se
                    tableBody.innerHTML = `
                        <tr>
                            <td><strong>GCP Cloud</strong></td>
                            <td>${new Date(data.gcp.updated).toLocaleString('hu-HU')}</td>
                            <td>${data.gcp.size_mb} MB</td>
                            <td><span class="badge bg-success">El√©rhet≈ë</span></td>
                        </tr>
                        <tr>
                            <td><strong>Helyi p√©ld√°ny</strong></td>
                            <td>${data.local.updated ? new Date(data.local.updated).toLocaleString('hu-HU') : 'N/A'}</td>
                            <td>${data.local.size_mb ? data.local.size_mb + ' MB' : 'N/A'}</td>
                            <td><span class="badge bg-${data.local.exists ? 'info' : 'secondary'}">${data.local.exists ? 'L√©tezik' : 'Nincs'}</span></td>
                        </tr>
                    `;
                    
                    // Let√∂lt√©s gomb enged√©lyez√©se, ha √∫jabb verzi√≥ van
                    downloadBtn.disabled = !isNewer;
                } else {
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = '‚ùå Hiba: ' + data.error;
                }
            })
            .catch(err => {
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = '‚ùå H√°l√≥zati hiba: ' + err;
            });
    }

    function downloadFromGCP() {
        if (!confirm('Let√∂lt√∂d a core_data.parquet f√°jlt a GCP-b≈ël? Ez fel√ºl√≠rja a megl√©v≈ë helyi f√°jlt.')) return;
        
        const alertDiv = document.getElementById('gcpAlert');
        const downloadBtn = document.getElementById('downloadBtn');
        
        alertDiv.className = 'alert alert-info';
        alertDiv.textContent = '‚¨áÔ∏è Let√∂lt√©s folyamatban... K√©rlek v√°rj, ez eltarthat n√©h√°ny percig.';
        downloadBtn.disabled = true;
        
        fetch('/admin/gcp/download', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alertDiv.className = 'alert alert-success';
                    alertDiv.innerHTML = `
                        <strong>‚úÖ Sikeres let√∂lt√©s!</strong><br>
                        üìä ${data.row_count.toLocaleString()} sor, ${data.col_count} oszlop<br>
                        üí° ${data.recommendation}
                    `;
                    // √öjraellen≈ërz√©s
                    setTimeout(() => checkGCPUpdate(), 1000);
                } else {
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = '‚ùå Hiba: ' + data.error;
                    downloadBtn.disabled = false;
                }
            })
            .catch(err => {
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = '‚ùå H√°l√≥zati hiba: ' + err;
                downloadBtn.disabled = false;
            });
    }

    // ========== Modul Tesztel√©s Funkci√≥k ==========
    function testModule(moduleName) {
        const resultsDiv = document.getElementById('moduleTestResults');
        const tableBody = document.getElementById('moduleTestTableBody');
        
        resultsDiv.classList.remove('d-none');
        
        const startTime = performance.now();
        fetch(`/admin/test-module/${moduleName}`)
            .then(res => res.json())
            .then(data => {
                const responseTime = (performance.now() - startTime).toFixed(0);
                addTestResult(moduleName, data, responseTime);
            })
            .catch(err => {
                const responseTime = (performance.now() - startTime).toFixed(0);
                addTestResult(moduleName, { success: false, message: err.toString() }, responseTime);
            });
    }

    function testAllModules() {
        const modules = ['redis', 'ollama', 'parquet', 'gcp', 'airflow', 'model'];
        const resultsDiv = document.getElementById('moduleTestResults');
        const tableBody = document.getElementById('moduleTestTableBody');
        
        resultsDiv.classList.remove('d-none');
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">üîç Tesztel√©s folyamatban...</td></tr>';
        
        // √ñsszes modul p√°rhuzamos tesztel√©se
        Promise.all(modules.map(moduleName => {
            const startTime = performance.now();
            return fetch(`/admin/test-module/${moduleName}`)
                .then(res => res.json())
                .then(data => ({
                    module: moduleName,
                    data: data,
                    responseTime: (performance.now() - startTime).toFixed(0)
                }))
                .catch(err => ({
                    module: moduleName,
                    data: { success: false, message: err.toString() },
                    responseTime: (performance.now() - startTime).toFixed(0)
                }));
        })).then(results => {
            tableBody.innerHTML = '';
            results.forEach(result => {
                addTestResult(result.module, result.data, result.responseTime);
            });
        });
    }

    function addTestResult(moduleName, data, responseTime) {
        const tableBody = document.getElementById('moduleTestTableBody');
        const moduleIcons = {
            redis: 'üóÑÔ∏è',
            ollama: 'ü§ñ',
            parquet: 'üìä',
            gcp: '‚òÅÔ∏è',
            airflow: 'üå™Ô∏è',
            model: 'üéØ'
        };
        
        const statusBadge = data.success 
            ? '<span class="badge bg-success">‚úÖ OK</span>' 
            : '<span class="badge bg-danger">‚ùå HIBA</span>';
        
        const row = `
            <tr>
                <td>${moduleIcons[moduleName] || 'üì¶'} <strong>${moduleName.toUpperCase()}</strong></td>
                <td>${statusBadge}</td>
                <td>${responseTime} ms</td>
                <td class="small">${data.message || data.error || data.details || 'N/A'}</td>
            </tr>
        `;
        
        // Ha m√°r van sor ezzel a modullal, cser√©lj√ºk ki
        const existingRow = Array.from(tableBody.rows).find(row => 
            row.cells[0].textContent.includes(moduleName.toUpperCase())
        );
        
        if (existingRow) {
            existingRow.outerHTML = row;
        } else {
            tableBody.insertAdjacentHTML('beforeend', row);
        }
    }
</script>
{% endblock %}
