{% extends "base.html" %}
{% block title %}Cache Admin{% endblock %}
{% block content %}
<div class="bg-light p-5 rounded mt-3">
    <h1>‚öôÔ∏è Rendszer Adminisztr√°ci√≥</h1>
    <p class="lead">Cache rendszer √©s ML Worker Filter kezel√©se.</p>
    
    <!-- Cache Statisztik√°k -->
    <h3 class="mt-4">üíæ LLM Cache Statisztik√°k</h3>
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">T√°rolt Elemek</h5>
                    <h2 id="cached-items">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Mem√≥ria Haszn√°lat</h5>
                    <h2 id="memory-used">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Cache TTL</h5>
                    <h2 id="cache-ttl">48 √≥ra</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Worker Filter Statisztik√°k -->
    <h3 class="mt-5">üéØ ML Worker Filter Statisztik√°k</h3>
    <div class="row mt-3">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">St√°tusz</h5>
                    <h2 id="ml-status">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Relev√°ns Mint√°k</h5>
                    <h2 id="ml-relevant">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Irrelev√°ns Mint√°k</h5>
                    <h2 id="ml-irrelevant">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Konfidencia Ar√°ny</h5>
                    <h2 id="ml-confidence">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Pool Statisztik√°k -->
    <h3 class="mt-5">üöÑ HTTP Connection Pool</h3>
    <div class="row mt-3">
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <h5 class="card-title">St√°tusz</h5>
                    <h2 id="conn-status">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Max Connections</h5>
                    <h2 id="conn-limit">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Per Host Limit</h5>
                    <h2 id="conn-per-host">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Keep-Alive</h5>
                    <h2 id="conn-keepalive">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Inkrement√°lis Feldolgoz√°s Statisztik√°k -->
    <h3 class="mt-5">üîÑ Inkrement√°lis Feldolgoz√°s</h3>
    <div class="row mt-3">
        <div class="col-md-4">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h5 class="card-title">Utols√≥ Feldolgoz√°s</h5>
                    <h4 id="inc-last-date">-</h4>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">T√°rolt Cikkek</h5>
                    <h2 id="inc-tracked-articles">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Metadata St√°tusz</h5>
                    <h2 id="inc-metadata-status">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Inkrement√°lis Feldolgoz√°s M≈±veletek -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>Inkrement√°lis Feldolgoz√°s M≈±veletek</h4>
        </div>
        <div class="card-body">
            <button id="reset-incremental" class="btn btn-danger">
                <i class="fas fa-redo"></i> Metadata T√∂rl√©se (Teljes √öjrafeldolgoz√°s)
            </button>
            <p class="text-muted mt-2 mb-0">
                <small>Figyelem: Ez t√∂rli az √∂sszes t√°rolt hash-t, √≠gy a k√∂vetkez≈ë feldolgoz√°s az √∂sszes cikket √∫jra elemzi.</small>
            </p>
        </div>
    </div>

    <!-- ML M≈±veletek -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>ML Worker Filter M≈±veletek</h4>
        </div>
        <div class="card-body">
            <button id="ml-retrain" class="btn btn-warning">
                <i class="fas fa-brain"></i> ML Modell √öjratan√≠t√°sa
            </button>
        </div>
    </div>
    
    <!-- Cache M≈±veletek -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>Cache M≈±veletek</h4>
        </div>
        <div class="card-body">
            <button id="refresh-stats" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Statisztik√°k Friss√≠t√©se
            </button>
            <button id="clear-cache" class="btn btn-danger ms-2">
                <i class="fas fa-trash"></i> Cache T√∂rl√©se
            </button>
        </div>
    </div>
    
    <!-- Cache M≈±k√∂d√©se -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>Cache Rendszer M≈±k√∂d√©se</h4>
        </div>
        <div class="card-body">
            <h5>üîë Kulcsgener√°l√°s:</h5>
            <ul>
                <li>SHA256 hash alap√∫ egyedi azonos√≠t√≥ minden le√≠r√°shoz</li>
                <li>Normaliz√°lt sz√∂veg (lowercase, whitespace cleanup)</li>
                <li>Azonos le√≠r√°sok azonos hash-t kapnak</li>
            </ul>
            
            <h5 class="mt-3">üíæ T√°rol√°s:</h5>
            <ul>
                <li>Redis-based perzisztens t√°rol√°s</li>
                <li>48 √≥r√°s automatikus lej√°rat (TTL)</li>
                <li>JSON serialization a struktur√°lt adatokhoz</li>
            </ul>
            
            <h5 class="mt-3">‚ö° Teljes√≠tm√©ny:</h5>
            <ul>
                <li>Cache HIT: Instant v√°lasz LLM h√≠v√°s n√©lk√ºl</li>
                <li>Cache MISS: LLM h√≠v√°s + eredm√©ny ment√©se</li>
                <li>Ism√©tl≈ëd≈ë le√≠r√°sok automatikusan felgyorsulnak</li>
            </ul>
            
            <h5 class="mt-3">üìä Monitoroz√°s:</h5>
            <ul>
                <li>Worker logok: "‚úÖ Cache HIT" / "‚ùå Cache MISS" √ºzenetek</li>
                <li>Feldolgoz√°s v√©g√©n r√©szletes cache statisztika</li>
                <li>Real-time hit rate √©s mem√≥ria haszn√°lat</li>
            </ul>
        </div>
    </div>
    
    <!-- Alert √ºzenetek -->
    <div id="alert-container" class="mt-3"></div>
</div>

<!-- FontAwesome ikonokhoz -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
// Statisztik√°k bet√∂lt√©se
function loadCacheStats() {
    fetch('/admin/cache/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                document.getElementById('cached-items').textContent = stats.cached_items || 0;
                document.getElementById('memory-used').textContent = 
                    (stats.memory_used_mb || 0).toFixed(2) + ' MB';
            } else {
                showAlert('Hiba: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Hiba a statisztik√°k bet√∂lt√©sekor: ' + error.message, 'danger');
        });
}
// ML modell √∫jratan√≠t√°sa
function retrainML() {
    if (!confirm('Biztosan √∫jra szeretn√©d tan√≠tani az ML modellt? Ez n√©h√°ny m√°sodpercig tarthat.')) {
        return;
    }
    
    fetch('/admin/ml/retrain', {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                loadMLStats();
            } else {
                showAlert('Hiba: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Hiba az ML √∫jratan√≠t√°sakor: ' + error.message, 'danger');
        });
}

// ML statisztik√°k bet√∂lt√©se
function loadMLStats() {
    fetch('/admin/ml/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                document.getElementById('ml-status').textContent = 
                    stats.is_trained ? '‚úÖ Akt√≠v' : '‚ùå Inakt√≠v';
                document.getElementById('ml-relevant').textContent = 
                    stats.relevant_samples || 0;
                document.getElementById('ml-irrelevant').textContent = 
                    stats.irrelevant_samples || 0;
                document.getElementById('ml-confidence').textContent = 
                    ((stats.confidence_rate || 0) * 100).toFixed(1) + '%';
            }
        })
        .catch(error => {
            console.error('ML stats hiba:', error);
        });
}

// Connection Pool statisztik√°k bet√∂lt√©se
function loadConnectionStats() {
    fetch('/admin/connection/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                document.getElementById('conn-status').textContent = 
                    stats.active ? '‚úÖ Akt√≠v' : '‚ùå Inakt√≠v';
                document.getElementById('conn-limit').textContent = 
                    stats.limit || '-';
                document.getElementById('conn-per-host').textContent = 
                    stats.limit_per_host || '-';
                document.getElementById('conn-keepalive').textContent = 
                    stats.keepalive_timeout ? stats.keepalive_timeout + 's' : '-';
            }
        })
        .catch(error => {
            console.error('Connection stats hiba:', error);
        });
}

// Inkrement√°lis feldolgoz√°s statisztik√°k bet√∂lt√©se
function loadIncrementalStats() {
    fetch('/admin/incremental/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                document.getElementById('inc-last-date').textContent = 
                    stats.last_processing_date || 'M√©g nem futott';
                document.getElementById('inc-tracked-articles').textContent = 
                    stats.tracked_articles || 0;
                document.getElementById('inc-metadata-status').textContent = 
                    stats.metadata_exists ? '‚úÖ L√©tezik' : '‚ùå Nincs';
            }
        })
        .catch(error => {
            console.error('Incremental stats hiba:', error);
        });
}

// Inkrement√°lis metadata t√∂rl√©se
function resetIncrementalMetadata() {
    if (!confirm('Biztosan t√∂r√∂lni szeretn√©d az inkrement√°lis feldolgoz√°s metaadatait?\n\nEz azt jelenti, hogy a k√∂vetkez≈ë feldolgoz√°s MINDEN cikket √∫jra fog elemezni, nem csak az √∫j/m√≥dos√≠tottakat. Ez t√∂bb id≈ët fog ig√©nybe venni.')) {
        return;
    }
    
    fetch('/admin/incremental/reset', {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                loadIncrementalStats();
            } else {
                showAlert('Hiba: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Hiba a metadata t√∂rl√©sekor: ' + error.message, 'danger');
        });
}

// √ñsszes statisztika bet√∂lt√©se
function loadAllStats() {
    loadCacheStats();
    loadMLStats();
    loadConnectionStats();
    loadIncrementalStats();
    showAlert('Statisztik√°k friss√≠tve', 'success');
}

// Cache t√∂rl√©se
function clearCache() {
    if (!confirm('Biztosan t√∂r√∂lni szeretn√©d a teljes cache-t? Ez visszavonhatatlan!')) {
        return;
    }
    
    fetch('/admin/cache/clear', {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                loadCacheStats();
            } else {
                showAlert('Hiba: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Hiba a cache t√∂rl√©sekor: ' + error.message, 'danger');
        });
}

// Alert megjelen√≠t√©se
function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alert);
    
    // Auto-dismiss ut√°n 5 m√°sodperc
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Event listeners
document.getElementById('refresh-stats').addEventListener('click', loadAllStats);
document.getElementById('clear-cache').addEventListener('click', clearCache);
document.getElementById('ml-retrain').addEventListener('click', retrainML);
document.getElementById('reset-incremental').addEventListener('click', resetIncrementalMetadata);

// Oldal bet√∂lt√©sekor automatikus friss√≠t√©s
window.addEventListener('DOMContentLoaded', loadAllStats);

// Auto-refresh 30 m√°sodpercenk√©nt
setInterval(loadAllStats, 30000);
</script>
{% endblock %}
