{% extends "base.html" %}
{% block title %}Vez√©rl≈ëpult{% endblock %}
{% block content %}
<div class="bg-light p-5 rounded mt-3">
    <h1>Vez√©rl≈ëpult</h1>
    <p class="lead">Itt ind√≠thatod el a hirdet√©sek teljes k√∂r≈± elemz√©s√©t √©s sz≈±r√©s√©t. A folyamat aszinkron m√≥don fut a h√°tt√©rben, √©s real-time k√∂vethet≈ë.</p>
    
    <!-- Progress tracking ter√ºlet -->
    <div id="progress-container" class="mt-4" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Feldolgoz√°si √°llapot</h4>
            <button id="reset-task" class="btn btn-danger btn-sm">
                <i class="fas fa-stop-circle"></i> Feldolgoz√°s Le√°ll√≠t√°sa & √öjraind√≠t√°s
            </button>
        </div>
        <div class="progress mb-3">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <div id="status-message" class="alert alert-info">Inicializ√°l√°s...</div>
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Feldolgozva</h5>
                        <h2 id="processed-count">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Relev√°ns</h5>
                        <h2 id="relevant-count">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Irrelev√°ns</h5>
                        <h2 id="irrelevant-count">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">√ñsszesen</h5>
                        <h2 id="total-count">-</h2>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ETA √©s teljes√≠tm√©ny metrik√°k -->
        <div class="row mt-3">
            <div class="col-md-4">
                <div class="card bg-secondary text-white">
                    <div class="card-body">
                        <h5 class="card-title">‚è±Ô∏è Eltelt id≈ë</h5>
                        <h3 id="elapsed-time">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark text-white">
                    <div class="card-body">
                        <h5 class="card-title">üéØ H√°tral√©v≈ë id≈ë (ETA)</h5>
                        <h3 id="eta-time">Sz√°m√≠t√°s...</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">‚ö° Feldolgoz√°si sebess√©g</h5>
                        <h3 id="processing-speed">-</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ind√≠t√≥ gomb -->
    <div id="start-container">
        <button id="start-pipeline" class="btn btn-lg btn-primary">
            <i class="fas fa-play"></i> LLM Adatfeldolgoz√°s Ind√≠t√°sa &raquo;
        </button>
    </div>
    
    <!-- Befejezett feladat inform√°ci√≥ -->
    <div id="completed-container" class="mt-4" style="display: none;">
        <div class="alert alert-success">
            <h4><i class="fas fa-check-circle"></i> Feldolgoz√°s befejezve!</h4>
            <p id="completion-message">Az adatfeldolgoz√°s sikeresen befejez≈ëd√∂tt.</p>
            <a href="{{ url_for('stats') }}" class="btn btn-success">Statisztik√°k megtekint√©se</a>
            <a href="{{ url_for('data_table') }}" class="btn btn-info">Adatok b√∂ng√©sz√©se</a>
        </div>
    </div>
</div>

<!-- WebSocket kapcsolat √©s progress tracking -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
let socket = null;
let currentTaskId = null;

// Oldal bet√∂lt√©sekor ellen≈ërizz√ºk, hogy van-e folyamatban l√©v≈ë task
window.addEventListener('DOMContentLoaded', function() {
    const savedTaskId = localStorage.getItem('currentTaskId');
    if (savedTaskId) {
        currentTaskId = savedTaskId;
        // Ellen≈ërizz√ºk, hogy a task m√©g fut-e
        fetch(`/task-status/${currentTaskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.status.status !== 'completed' && data.status.status !== 'failed') {
                    // Task m√©g fut, folytassuk a k√∂vet√©st
                    showProgressContainer();
                    hideStartContainer();
                    updateProgressDisplay(data.status);
                    connectWebSocket();
                } else {
                    // Task befejez≈ëd√∂tt vagy nem l√©tezik, tiszt√≠tsuk a localStorage-t
                    localStorage.removeItem('currentTaskId');
                    currentTaskId = null;
                    if (data.success && data.status.status === 'completed') {
                        showProgressContainer();
                        hideStartContainer();
                        showCompletedContainer(data.status.message);
                        updateProgressDisplay(data.status);
                    }
                }
            })
            .catch(error => {
                console.log('Nincs akt√≠v task');
                localStorage.removeItem('currentTaskId');
                currentTaskId = null;
            });
    }
});

document.getElementById('start-pipeline').addEventListener('click', function() {
    startDataProcessing();
});

// Reset task button handler
document.getElementById('reset-task').addEventListener('click', function() {
    if (confirm('Biztosan le szeretn√©d √°ll√≠tani a feldolgoz√°st √©s √∫jra kezdeni?\n\nEz t√∂rli a jelenlegi task √°llapotot √©s lehet≈ëv√© teszi √∫j feldolgoz√°s ind√≠t√°s√°t.')) {
        resetTask();
    }
});

function resetTask() {
    // WebSocket lecsatlakoztat√°sa
    if (socket) {
        socket.disconnect();
        socket = null;
    }
    
    // Polling le√°ll√≠t√°sa
    if (window.progressPollingInterval) {
        clearInterval(window.progressPollingInterval);
        window.progressPollingInterval = null;
    }
    
    // Task ID t√∂rl√©se
    localStorage.removeItem('currentTaskId');
    currentTaskId = null;
    
    // UI reset
    hideProgressContainer();
    hideCompletedContainer();
    showStartContainer();
    resetStartButton();
    
    // Success message
    showAlert('A feldolgoz√°s le√°ll√≠tva. Most √∫jra elind√≠thatod az adatfeldolgoz√°st.', 'info');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.bg-light').insertBefore(alertDiv, document.querySelector('.bg-light').firstChild.nextSibling);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function startDataProcessing() {
    // Gomb letilt√°sa
    const startBtn = document.getElementById('start-pipeline');
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ind√≠t√°s...';
    
    // API h√≠v√°s az adatfeldolgoz√°s ind√≠t√°s√°ra
    fetch('/run-pipeline', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTaskId = data.task_id;
            // Task ID ment√©se localStorage-ba
            localStorage.setItem('currentTaskId', currentTaskId);
            showProgressContainer();
            connectWebSocket();
            hideStartContainer();
        } else {
            alert('Hiba: ' + data.message);
            resetStartButton();
        }
    })
    .catch(error => {
        console.error('Hiba:', error);
        alert('Hiba t√∂rt√©nt a feldolgoz√°s ind√≠t√°sakor');
        resetStartButton();
    });
}

function connectWebSocket() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('WebSocket kapcsolat l√©trej√∂tt');
        if (currentTaskId) {
            socket.emit('subscribe_to_task', {'task_id': currentTaskId});
            // HTTP polling backup ind√≠t√°sa is
            startProgressPolling();
        }
    });
    
    socket.on('status_update', function(data) {
        updateProgressDisplay(data);
    });
    
    socket.on('disconnect', function() {
        console.log('WebSocket kapcsolat megszakadt');
        // WebSocket megszakad√°s eset√©n HTTP polling-ra v√°lt√°s
        startProgressPolling();
    });
}

// HTTP polling backup mechanism
function startProgressPolling() {
    if (window.progressPollingInterval) {
        clearInterval(window.progressPollingInterval);
    }
    
    window.progressPollingInterval = setInterval(() => {
        if (currentTaskId) {
            fetch(`/task-status/${currentTaskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateProgressDisplay(data.status);
                        // Ha befejez≈ëd√∂tt, √°ll√≠tsuk le a polling-ot
                        if (data.status.status === 'completed' || data.status.status === 'failed') {
                            clearInterval(window.progressPollingInterval);
                            window.progressPollingInterval = null;
                        }
                    }
                })
                .catch(error => console.log('Polling hiba:', error));
        }
    }, 2000); // 2 m√°sodpercenk√©nt
}

function updateProgressDisplay(status) {
    // Progress bar friss√≠t√©se
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = status.progress + '%';
    progressBar.textContent = Math.round(status.progress) + '%';
    progressBar.setAttribute('aria-valuenow', status.progress);
    
    // St√°tusz √ºzenet friss√≠t√©se
    document.getElementById('status-message').innerHTML = 
        '<i class="fas fa-info-circle"></i> ' + status.message;
    
    // Sz√°ml√°l√≥k friss√≠t√©se
    document.getElementById('processed-count').textContent = status.processed_items || 0;
    document.getElementById('relevant-count').textContent = status.relevant_found || 0;
    document.getElementById('irrelevant-count').textContent = status.irrelevant_found || 0;
    document.getElementById('total-count').textContent = status.total_items || '-';
    
    // ETA √©s teljes√≠tm√©ny metrik√°k friss√≠t√©se
    if (status.elapsed_seconds !== null && status.elapsed_seconds !== undefined) {
        document.getElementById('elapsed-time').textContent = formatTime(status.elapsed_seconds);
    }
    
    if (status.eta_seconds !== null && status.eta_seconds !== undefined && status.eta_seconds > 0) {
        document.getElementById('eta-time').textContent = formatTime(status.eta_seconds);
    } else if (status.progress > 1.0) {
        document.getElementById('eta-time').textContent = 'Sz√°m√≠t√°s...';
    }
    
    if (status.items_per_second !== null && status.items_per_second !== undefined) {
        const speed = status.items_per_second;
        if (speed < 1) {
            document.getElementById('processing-speed').textContent = 
                (speed * 60).toFixed(1) + ' elem/perc';
        } else {
            document.getElementById('processing-speed').textContent = 
                speed.toFixed(2) + ' elem/sec';
        }
    }
    
    // Ha befejez√©s
    if (status.status === 'completed') {
        showCompletedContainer(status.message);
        progressBar.classList.remove('progress-bar-animated');
        document.getElementById('eta-time').textContent = '‚úÖ K√©sz!';
    } else if (status.status === 'failed') {
        showErrorState(status.message);
    }
}

// Id≈ëform√°z√≥ helper f√ºggv√©ny
function formatTime(seconds) {
    if (seconds < 60) {
        return Math.round(seconds) + 's';
    } else if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return minutes + 'm ' + secs + 's';
    } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return hours + 'h ' + minutes + 'm';
    }
}

function showProgressContainer() {
    document.getElementById('progress-container').style.display = 'block';
}

function hideStartContainer() {
    document.getElementById('start-container').style.display = 'none';
}

function showCompletedContainer(message) {
    document.getElementById('completed-container').style.display = 'block';
    document.getElementById('completion-message').textContent = message;
    
    // Task ID t√∂rl√©se localStorage-b√≥l
    localStorage.removeItem('currentTaskId');
    currentTaskId = null;
    
    // Polling le√°ll√≠t√°sa
    if (window.progressPollingInterval) {
        clearInterval(window.progressPollingInterval);
        window.progressPollingInterval = null;
    }
    
    if (socket) {
        socket.disconnect();
    }
}

function hideProgressContainer() {
    document.getElementById('progress-container').style.display = 'none';
}

function hideCompletedContainer() {
    document.getElementById('completed-container').style.display = 'none';
}

function showStartContainer() {
    document.getElementById('start-container').style.display = 'block';
}

function showErrorState(message) {
    const statusMessage = document.getElementById('status-message');
    statusMessage.className = 'alert alert-danger';
    statusMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Hiba: ' + message;
    
    // √öjraind√≠t√°s gomb megjelen√≠t√©se
    resetStartButton();
    document.getElementById('start-container').style.display = 'block';
}

function resetStartButton() {
    const startBtn = document.getElementById('start-pipeline');
    startBtn.disabled = false;
    startBtn.innerHTML = '<i class="fas fa-play"></i> LLM Adatfeldolgoz√°s Ind√≠t√°sa &raquo;';
}
</script>
{% endblock %}