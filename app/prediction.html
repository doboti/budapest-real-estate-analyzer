{% extends "base.html" %}
{% block title %}ML √Årpredikci√≥{% endblock %}
{% block content %}
<div class="mt-3">
    <h1>ü§ñ ML √Årpredikci√≥</h1>
    <p class="text-muted">Ingatlan√°rak el≈ërejelz√©se g√©pi tanul√°si modellel - T√∂bb modell √∂sszehasonl√≠t√°sa</p>
    <div class="alert alert-info">
        <small><strong>üß† √ñsszehasonl√≠tott modellek:</strong> Random Forest, XGBoost, Neural Network (MLP), SVM, KNN, Stacking Ensemble | A legjobb automatikusan kiv√°lasztva</small>
    </div>
    
    {% if not model_exists %}
    <div class="alert alert-warning">
        <h5>‚ö†Ô∏è A modell m√©g nincs betan√≠tva!</h5>
        <p>A modell tan√≠t√°s√°hoz admin jogosults√°g sz√ºks√©ges.</p>
        {% if session.get('logged_in') %}
        <form action="{{ url_for('train_model_route') }}" method="post">
            <button type="submit" class="btn btn-primary">Modell Tan√≠t√°sa</button>
        </form>
        {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-primary">Bejelentkez√©s</a>
        {% endif %}
    </div>
    {% else %}
    
    <!-- Best Model Info -->
    <div class="alert alert-success mb-4">
        <h5>üèÜ Kiv√°lasztott Legjobb Modell: <strong>{{ model_name }}</strong></h5>
        <p class="mb-0"><small>Ez a modell √©rte el a legjobb R¬≤ √©rt√©ket a tesztel√©s sor√°n.</small></p>
    </div>
    
    <!-- Model Comparison Table -->
    {% if all_results %}
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5>üìä Modell √ñsszehasonl√≠t√°s</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Modell</th>
                            <th>R¬≤ Score</th>
                            <th>MAPE (%)</th>
                            <th>MAE (Ft)</th>
                            <th>Log MAE</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in all_results %}
                        <tr {% if result.model == model_name %}class="table-success"{% endif %}>
                            <td>
                                {{ result.model }}
                                {% if result.model == model_name %}<span class="badge bg-success">Kiv√°lasztva</span>{% endif %}
                            </td>
                            <td>{{ "%.4f"|format(result.test_r2) }}</td>
                            <td>{{ "%.2f"|format(result.test_mape) }}%</td>
                            <td>{{ "{:,.0f}".format(result.test_mae) }}</td>
                            <td>{{ "%.4f"|format(result.test_mae_log) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Model Metrics -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5>üìä Modell Teljes√≠tm√©ny</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <h6>Teszt R¬≤ Score</h6>
                    <h3>{{ "%.4f"|format(metrics.test_r2) }}</h3>
                    <small class="text-muted">Pontoss√°g (1.0 = t√∂k√©letes)</small>
                </div>
                <div class="col-md-3">
                    <h6>Teszt MAPE</h6>
                    <h3>{{ "%.2f"|format(metrics.test_mape) }}%</h3>
                    <small class="text-muted">√Åtlagos sz√°zal√©kos hiba</small>
                </div>
                <div class="col-md-3">
                    <h6>Teszt MAE</h6>
                    <h3>{{ "{:,.0f}".format(metrics.test_mae) }} Ft</h3>
                    <small class="text-muted">√Åtlagos abszol√∫t hiba</small>
                </div>
                <div class="col-md-3">
                    <h6>Log-sk√°la MAE</h6>
                    <h3>{{ "%.4f"|format(metrics.test_mae_log) }}</h3>
                    <small class="text-muted">Hiba log transzform√°lt sk√°l√°n</small>
                </div>
            </div>
            
            {% if feature_importance %}
            <hr>
            <h6 class="mt-3">üîù Top 10 Legfontosabb V√°ltoz√≥k</h6>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Fontoss√°g</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feat in feature_importance %}
                    <tr>
                        <td>{{ feat.feature }}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ (feat.importance * 100)|round(2) }}%"
                                     aria-valuenow="{{ (feat.importance * 100)|round(2) }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ "%.2f"|format(feat.importance * 100) }}%
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
            
            {% if session.get('logged_in') %}
            <form action="{{ url_for('train_model_route') }}" method="post" class="mt-3">
                <button type="submit" class="btn btn-sm btn-secondary">Modell √öjratan√≠t√°sa</button>
            </form>
            {% endif %}
        </div>
    </div>
    
    <!-- Prediction Form -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5>üè† Ingatlan√°r Becsl√©s</h5>
        </div>
        <div class="card-body">
            <form id="predictionForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="area_sqm" class="form-label">Ter√ºlet (m¬≤) *</label>
                            <input type="number" class="form-control" id="area_sqm" name="area_sqm" 
                                   min="10" max="500" step="1" value="60" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="rooms" class="form-label">Szob√°k sz√°ma *</label>
                            <input type="number" class="form-control" id="rooms" name="rooms" 
                                   min="0.5" max="10" step="0.5" value="2" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="district" class="form-label">Ker√ºlet *</label>
                            <select class="form-select" id="district" name="district" required>
                                <option value="">V√°lassz ker√ºletet...</option>
                                <option value="I. ker√ºlet">I. ker√ºlet</option>
                                <option value="II. ker√ºlet">II. ker√ºlet</option>
                                <option value="III. ker√ºlet">III. ker√ºlet</option>
                                <option value="IV. ker√ºlet">IV. ker√ºlet</option>
                                <option value="V. ker√ºlet">V. ker√ºlet</option>
                                <option value="VI. ker√ºlet">VI. ker√ºlet</option>
                                <option value="VII. ker√ºlet">VII. ker√ºlet</option>
                                <option value="VIII. ker√ºlet">VIII. ker√ºlet</option>
                                <option value="IX. ker√ºlet">IX. ker√ºlet</option>
                                <option value="X. ker√ºlet">X. ker√ºlet</option>
                                <option value="XI. ker√ºlet">XI. ker√ºlet</option>
                                <option value="XII. ker√ºlet">XII. ker√ºlet</option>
                                <option value="XIII. ker√ºlet">XIII. ker√ºlet</option>
                                <option value="XIV. ker√ºlet">XIV. ker√ºlet</option>
                                <option value="XV. ker√ºlet">XV. ker√ºlet</option>
                                <option value="XVI. ker√ºlet">XVI. ker√ºlet</option>
                                <option value="XVII. ker√ºlet">XVII. ker√ºlet</option>
                                <option value="XVIII. ker√ºlet">XVIII. ker√ºlet</option>
                                <option value="XIX. ker√ºlet">XIX. ker√ºlet</option>
                                <option value="XX. ker√ºlet">XX. ker√ºlet</option>
                                <option value="XXI. ker√ºlet">XXI. ker√ºlet</option>
                                <option value="XXII. ker√ºlet">XXII. ker√ºlet</option>
                                <option value="XXIII. ker√ºlet">XXIII. ker√ºlet</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="floor" class="form-label">Emelet</label>
                            <input type="number" class="form-control" id="floor" name="floor" 
                                   min="-1" max="20" step="1" value="2">
                            <small class="text-muted">-1 = szuter√©n, 0 = f√∂ldszint</small>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="building_type" class="form-label">√âp√≠t√©si m√≥d</label>
                            <select class="form-select" id="building_type" name="building_type">
                                <option value="unknown">Ismeretlen</option>
                                <option value="tegla">T√©gla</option>
                                <option value="panel">Panel</option>
                                <option value="egyeb">Egy√©b</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="property_category" class="form-label">Ingatlan t√≠pusa</label>
                            <select class="form-select" id="property_category" name="property_category">
                                <option value="unknown">Ismeretlen</option>
                                <option value="lakas">Lak√°s</option>
                                <option value="haz">H√°z</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="has_terrace" class="form-label">Terasz/Erk√©ly</label>
                            <select class="form-select" id="has_terrace" name="has_terrace">
                                <option value="false">Nincs</option>
                                <option value="true">Van</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-lg btn-primary">
                    <span id="predSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                    √År Becsl√©se
                </button>
            </form>
            
            <!-- Prediction Result -->
            <div id="predictionResult" class="mt-4 d-none">
                <div class="alert alert-info">
                    <h4>üí∞ Becs√ºlt √År: <span id="predictedPrice"></span></h4>
                    <p class="mb-0">N√©gyzetm√©ter√°r: <span id="pricePerSqm"></span></p>
                </div>
            </div>
            
            <div id="predictionError" class="alert alert-danger mt-4 d-none"></div>
        </div>
    </div>
    
    {% endif %}
</div>

<script>
document.getElementById('predictionForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const spinner = document.getElementById('predSpinner');
    const resultDiv = document.getElementById('predictionResult');
    const errorDiv = document.getElementById('predictionError');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    // Reset
    resultDiv.classList.add('d-none');
    errorDiv.classList.add('d-none');
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/predict-price', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('predictedPrice').textContent = data.formatted_price;
            document.getElementById('pricePerSqm').textContent = data.price_per_sqm;
            resultDiv.classList.remove('d-none');
        } else {
            errorDiv.textContent = data.error || 'Hiba t√∂rt√©nt a becsl√©s sor√°n.';
            errorDiv.classList.remove('d-none');
        }
    } catch (error) {
        errorDiv.textContent = 'H√°l√≥zati hiba: ' + error.message;
        errorDiv.classList.remove('d-none');
    } finally {
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}
