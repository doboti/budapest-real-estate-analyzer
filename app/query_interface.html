{% extends "base.html" %}
{% block title %}Lek√©rdez√©s{% endblock %}
{% block content %}
<div class="mt-3">
    <h1>Adatlek√©rdez√©s</h1>
    <p class="text-muted">V√°lassz a lek√©rdez√©si m√≥dok k√∂z√∂tt</p>
    
    <!-- Tab navigation -->
    <ul class="nav nav-tabs" id="queryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab" aria-controls="chat" aria-selected="true">
                üí¨ Chat (Term√©szetes nyelv)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sql-tab" data-bs-toggle="tab" data-bs-target="#sql" type="button" role="tab" aria-controls="sql" aria-selected="false">
                üóÑÔ∏è SQL Lek√©rdez≈ë
            </button>
        </li>
    </ul>
    
    <!-- Tab content -->
    <div class="tab-content border border-top-0 p-4" id="queryTabsContent">
        <!-- Chat Tab -->
        <div class="tab-pane fade show active" id="chat" role="tabpanel" aria-labelledby="chat-tab">
            <h4>K√©rdezz az adatokr√≥l term√©szetes nyelven!</h4>
            <p class="text-muted">P√©ld√°k: "H√°ny akt√≠v hirdet√©s van jelenleg a VI. ker√ºletben?", "Mi az √°tlag√°r a II. ker√ºletben?", "H√°ny hirdet√©st adtak fel decemberben?"</p>
            <div class="alert alert-info mb-3">
                <small><strong>ü§ñ LLM:</strong> llama3.2:3b (Ollama) | Term√©szetes nyelvi SQL gener√°l√°s √©s v√°laszok</small>
            </div>
            
            <form id="chatForm">
                <div class="mb-3">
                    <label for="chatQuestion" class="form-label">K√©rd√©sed:</label>
                    <input type="text" class="form-control" id="chatQuestion" name="question" placeholder="pl. H√°ny akt√≠v hirdet√©s van a VI. ker√ºletben?" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="chatSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    K√©rdezz!
                </button>
            </form>
            
            <!-- V√°lasz megjelen√≠t√©se -->
            <div id="chatAnswer" class="mt-4 d-none">
                <div class="alert alert-success">
                    <h5>V√°lasz:</h5>
                    <p id="answerText"></p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <strong>Gener√°lt SQL:</strong>
                    </div>
                    <div class="card-body">
                        <code id="sqlQuery" class="d-block bg-light p-2"></code>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h5>Eredm√©nyek:</h5>
                    <div class="table-responsive" id="chatResults"></div>
                </div>
            </div>
            
            <!-- Hiba megjelen√≠t√©se -->
            <div id="chatError" class="alert alert-danger mt-4 d-none"></div>
        </div>
        
        <!-- SQL Tab -->
        <div class="tab-pane fade" id="sql" role="tabpanel" aria-labelledby="sql-tab">
            <h4>Futtass SQL lek√©rdez√©st</h4>
            <p class="text-muted">√çrd meg a saj√°t SQL SELECT utas√≠t√°sodat a <code>relevant_data</code> t√°bl√°ra.</p>
            
            <form method="POST" action="{{ url_for('sql_query') }}">
                <div class="mb-3">
                    <label for="sqlQuery" class="form-label">SQL Lek√©rdez√©s:</label>
                    <textarea class="form-control" id="sqlQueryInput" name="query" rows="6" required>SELECT district, COUNT(*) as count FROM relevant_data GROUP BY district ORDER BY count DESC;</textarea>
                </div>
                <button type="submit" class="btn btn-primary">Lek√©rdez√©s futtat√°sa</button>
            </form>
            
            <div class="mt-4">
                <h5>El√©rhet≈ë oszlopok:</h5>
                <p class="text-muted small">article_id, title, price_huf, price_eur, rooms, area_sqm, price_per_sqm, description, district, valid_from, valid_till, floor, street, building_type, property_category, has_terrace</p>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const spinner = document.getElementById('chatSpinner');
    const answerDiv = document.getElementById('chatAnswer');
    const errorDiv = document.getElementById('chatError');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    // Reset
    answerDiv.classList.add('d-none');
    errorDiv.classList.add('d-none');
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/chat-query', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // V√°lasz megjelen√≠t√©se
            document.getElementById('answerText').textContent = data.answer;
            document.getElementById('sqlQuery').textContent = data.sql_query;
            document.getElementById('chatResults').innerHTML = data.results_html;
            answerDiv.classList.remove('d-none');
        } else {
            errorDiv.textContent = data.error || 'Hiba t√∂rt√©nt a lek√©rdez√©s sor√°n.';
            errorDiv.classList.remove('d-none');
        }
    } catch (error) {
        errorDiv.textContent = 'H√°l√≥zati hiba: ' + error.message;
        errorDiv.classList.remove('d-none');
    } finally {
        spinner.classList.add('d-none');
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}
